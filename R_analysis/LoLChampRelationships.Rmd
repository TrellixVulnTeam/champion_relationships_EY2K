---
title: "League Champion Relationships"
author: "Santiago Torres"
date: "October 21, 2016"
output: html_document
---

```{r setup, include=FALSE}
library(png)
library(igraph)
library(jsonlite)
library(dplyr)
champ_relations = fromJSON("champions.json")
path_to_files = "C:/Users/TORRES_SANT/Documents/Programming/webscrapping/champion_relationships/R_analysis/img"
```

## Exploring The Data

Lets take a look at the data we got in our newly created .json file.


```{r}
#how long is this? how many champions
numChampions <- nrow(champ_relations)
numChampions

#what are the column names?
colnames(champ_relations)

# i dont like the order so lets change it up

newchamp_relations <- champ_relations[,c(2,3,1,4)]

head(newchamp_relations)

# lets try create a vector of all the champions

testVertexNames <- as.vector(newchamp_relations$champion_name)
head(testVertexNames)

#this weird format is due to the JSON data

#lets just iterate through the champion names to store the vertexNames
vertexNames <- c()

for (champ in newchamp_relations$champion_name){
  vertexNames = c(vertexNames,tolower(champ))
}

#make sure we got all of them
length(vertexNames) == numChampions
head(vertexNames)

#However, it turns out there is a relationship with a non champion!, Kled has a friend Skarl which appears in the data
vertexNames = c(vertexNames, "skaarl")
```

In order to add our edges of friends, we have to iterate through it again
since JSON stores multiple friends in one pair with their respective champion, we cannot use the same iteration
Edges are also more complex because we have to store the champion with its edge

Here is the data for friends

```{r}
head(newchamp_relations$friends)
# note the pair in [[2]]
# we have to create a better loop
# so we have to create an instance of the champion for each friend connection it has

#the original data 
edgeFriendsSource <- c() #empty edge for loop
edgeFriendsTarget <- c()

i = 1
f = 1

while(i <= numChampions) {
  #champName
  champName = newchamp_relations$champion_name[[i]]
  #how many friends?
  numFriends = length(newchamp_relations$friends[[i]])
  
  while (numFriends > 0 && f <= numFriends){
    if (newchamp_relations$friends[[i]][f] !="")
      {
      edgeFriendsSource = c(edgeFriendsSource,tolower(champName))
      edgeFriendsTarget = c(edgeFriendsTarget, tolower(newchamp_relations$friends[[i]][f]))
    }
    f = f + 1
    }
  f = 1
  i = i +1
}
head(edgeFriendsSource)
head(edgeFriendsTarget)
```

Lets create the attributes for the faction of champions

```{r}
i = 1
f = 1
edgeFactionSource <- c() #empty edge for loop
edgeFactionTarget <- c()
while(i <= numChampions) {
  #champName
  numFactions = length(newchamp_relations$faction[i])
  for (faction in newchamp_relations$faction){
    if (f < 134) {
    if (newchamp_relations$faction[[f]] !="" && f < 134)
    {
      champName = newchamp_relations$champion_name[[f]] #133
      edgeFactionSource = c(edgeFactionSource, tolower(champName))
      edgeFactionTarget = c(edgeFactionTarget, newchamp_relations$faction[[f]])
    }
    f = f + 1
    }
  }
  i = i+1
}
head(edgeFactionSource)
head(edgeFactionTarget)
```

Lets create the rival connections for the graph

```{r}
edgeRivals <- c() #empty edge for loop

i = 1
f = 1

while(i <= numChampions) {
  #champName
  champName = newchamp_relations$champion_name[[i]]
  #how many rivals?
  numRivals = length(newchamp_relations$rivals[[i]])
  
  while (numRivals > 0 && f <= numRivals){
    if (newchamp_relations$rivals[[i]][f] !="")
      {
      edgeRivals = c(edgeRivals,tolower(champName), tolower(newchamp_relations$rivals[[i]][f]))
    }
    f = f + 1
    }
  f = 1
  i = i +1
}
edgeRivals[276] = "wukong" # it was labeled as monkeyking, which threw errors in the graph
```

###Variables for graph
```{r}
vertexSize <- 7
vLabelSize <- 1
vLabelDist <- 0
vLabelColor <- "darkblue"
vLabelFont <- 2 # bold text
vLabelDegree = -pi/2
eArrowSize <- 1
eArrowWidth<- .7

##global
#l <- layout.fruchterman.reingold
l <- layout.kamada.kawai

```

Graph of both

```{r}
dfEdge = as.data.frame(edgeFriendsSource, stringsAsFactors=FALSE)
dfEdge["friendsTarget"] = edgeFriendsTarget
# vertex dataframe
dfVertex = as.data.frame(vertexNames, stringsAsFactors=FALSE)
dfVertex["ID"] = vertexNames

both = graph_from_data_frame(d=dfEdge, vertices = dfVertex, directed = T)
E(both)$color <- "darkgreen" # green for friends
both <- add_edges(both, edgeRivals, attr=list(color="red")) #red for enemies
L <- layout.fruchterman.reingold(both, niter=10000)
plot(both, layout = L)
#awesome, it works
```

Here we add factions

```{r}
# add factions
V(both)$Faction = as.character(edgeFactionTarget[match(V(both)$name, edgeFactionSource)])
head(V(both)$Faction)
allFactions = unique(V(both)$Faction)
factionColors <- c('red',NA,'lightblue','blue','brown','gold','lawngreen','orange',NA,'purple', 'black','darkgreen','darkgray','ivory','darkblue',NA,NA,NA,NA,NA)

# add a key for colors
factionNumber <- function ( faction ) {
  match( faction, allFactions )}

V(both)$color <- factionColors[factionNumber(V(both)$Faction)]
```

graph both

```{r}
plot(both, layout = L)
```

This is very ugly so let's try and fix it up.

```{r}
V(both)$size <- vertexSize
V(both)$label.cex <- vLabelSize
V(both)$label.dist <- vLabelDist
V(both)$label.color <- vLabelColor
V(both)$label.font <- vLabelFont
V(both)$label.degree = vLabelDegree
E(both)$arrow.size <- eArrowSize
E(both)$arrow.width <- eArrowWidth
#pdf("both.pdf",10,10) saves graph as a pdf
plot(both, layout=l, asp = 0, frame = TRUE, main = "Champion Relationships")

```

Friends graph
```{r fig.width= 18, fig.height= 18}
friends <- graph_from_data_frame(d=dfEdge, vertices = dfVertex, direct = T)
E(friends)$color <- "darkgreen" # green for friends
V(friends)$Faction = as.character(edgeFactionTarget[match(V(friends)$name, edgeFactionSource)])
#Factions added!
allFactions = unique(V(friends)$Faction)
factionColors <- c('red',NA,'lightblue','blue','brown','gold','lawngreen','orange',NA,'purple', 'black','darkgreen','darkgray','ivory','darkblue',NA,NA,NA,NA,NA)

V(friends)$color <- factionColors[factionNumber(V(friends)$Faction)]
V(friends)$size <- vertexSize
V(friends)$label.cex <- vLabelSize
V(friends)$label.dist <- vLabelDist
V(friends)$label.color <- vLabelColor
V(friends)$label.font <- vLabelFont
V(friends)$label.degree = vLabelDegree
E(friends)$arrow.size <- eArrowSize
E(friends)$arrow.width <- eArrowWidth

pdf("friends.pdf",10,10) #saves graph as a pdf
plot(friends, frame = TRUE, main = "Champion Friendships")
# legend(x=-1.5, y=-1.1, c("Newspaper","Television", "Online News"), pch=21,
# 
#        col="#777777", pt.bg=colrs, pt.cex=2, cex=.8, bty="n", ncol=1)
```


Rivals graph
```{r}
rivals <- make_empty_graph() + vertices ( vertexNames)
rivals <- add_edges(rivals, edgeRivals, attr=list(color="red")) #red for enemies
E(rivals)$color <- "darkred" # red for rivals
V(rivals)$Faction = as.character(edgeFactionTarget[match(V(rivals)$name, edgeFactionSource)])
#Factions added!
allFactions = unique(V(rivals)$Faction)
factionColors <- c('red',NA,'lightblue','blue','brown','gold','lawngreen','orange',NA,'purple', 'black','darkgreen','darkgray','ivory','darkblue',NA,NA,NA,NA,NA)

V(rivals)$color <- factionColors[factionNumber(V(rivals)$Faction)]
V(rivals)$size <- vertexSize
V(rivals)$label.cex <- vLabelSize
V(rivals)$label.dist <- vLabelDist
V(rivals)$label.color <- vLabelColor
V(rivals)$label.font <- vLabelFont
V(rivals)$label.degree = vLabelDegree
E(rivals)$arrow.size <- eArrowSize
E(rivals)$arrow.width <- eArrowWidth
#pdf("rivals.pdf",10,10) saves graph as a pdf
plot(rivals, layout=l, asp = 0, frame = TRUE, main = "Champion Rivals")
```

```{r}
#testing images
x = 1
img <- list()
imgname <- list()
  
for (x in 1:2)
    {
    imgname = c(imgname, paste(vertexNames[x], ".png", sep =""))
    imgfilename <- file.path(path_to_files,imgname[[x]])
    aa = 1
      while (aa < 2) 
        {
          img[[aa]] <- readPNG(imgfilename[aa])
          aa = aa + 1
      }
    }

imgtest <- readPNG(imgfilename)

# V(g)$raster <- 
#   for (i in vcount(g)) {
#     replicate(
#   vcount(g),
#   fimgtest, 
#   simplify=FALSE)
# 
# plot(g, vertex.shape="raster")

# L[,1]=(L[,1]-min(L[,1]))/(max(L[,1])-min(L[,1]))*2-1
# L[,2]=(L[,2]-min(L[,2]))/(max(L[,2])-min(L[,2]))*2-1

#g$raster <-replicate(vcount(g),imgtest,simplify = FALSE)
#plot(g, layout=l, asp = 0, frame = TRUE, main = "Champion Relationships", vertex.shape="raster",vertex.label=NA,
#     vertex.size=25,vertex.size2=25)

#apply(L,1,function(x)rasterImage(imgtest,x[1]-0.1,x[2]-0.1,x[1]+0.1,x[2]+0.1))


g <- graph.ring(10)
# This is a complex attribute, so supply a list here
V(g)$raster <- replicate(vcount(g), imgtest, simplify=FALSE)
E(g)$color <- "green"
E(g)$width <- 5
plot(g, vertex.shape="raster", vertex.label=NA,vertex.size=1:10*5, vertex.size2=1:10*5)
```

```{r}
# x=1
# img <- list()
# imgname <- list()
# for (x in 1:length(vertexNames)){
#   imgname = c(imgname, paste(vertexNames[x], ".png", sep =""))
#   imgfilename <- c(imgfilename, file.path(path_to_files, imgname[[x]]))
# }
# x=1
# while (x < length(vertexNames)) {
#     img <- c(img, readPNG(imgfilename[x]))
#     x = x + 1
# }
# 
# V(g)$raster = img[1]
# V(g)$size <- 10
# V(g)$label.cex <- .3
# V(g)$label.dist <- 0
# V(g)$label.color <- 'gray'
# V(g)$label.font <- 2 # bold text
# E(g)$arrow.size <- 0.25
# E(g)$arrow.width <- .25
# g = graph_from_data_frame(d=dfEdge, vertices = dfVertex, directed = T)
# E(g)$color <- "green" # green for friends
# g <- add_edges(g, edgeRivals, attr=list(color="red")) #red for enemies
# l <- layout.fruchterman.reingold(g, niter=10000)
# 
# plot(g, layout=l, asp = 0, frame = TRUE, main = "Champion Relationships")
# V(g)$raster <- replicate(vcount(g), imgtest, simplify=FALSE)
# for(i in 1:nrow(L)) {  
#   rasterImage(img[[i]], l[i, 1]-0.2, l[i, 2]-0.2, l[i, 1]+0.2, l[i, 2]+0.2)
# }
# get.vertex.attribute(friends, 'name')[1] gives me all names. can set raster for each if aatrox == aatrox.png
#V(friends)[1]  or V(friends)[1]$name
#get.vertex.attribute(friends, 'name', index= V(friends)[1])
#set.vertex.attribute(friends, 'raster', index= V(friends)[1], value = imgtest) ## error -> number of itmes to replace not mutlitple of replacement length

```